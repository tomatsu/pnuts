<html>
    <head>
      <title>Pnuts User's Guide</title>
      <META Http-Equiv="Content-Type" content="text/html; charset=ISO-8859-1">
      <META Http-Equiv="Content-Style-Type" Content="text/css">
      <LINK Type="text/css" Rel="stylesheet" Href="stylesheet.css">
    </head>
    <body>

<div class="nav">
<a href="guide.html">Pnuts User's Guide</a> -> Cancelling Script Execution
</div>

<h2>Cancelling Script Execution</h2>

<h3><tt>Context.updateLine(int)</tt></h3>
<p>
During a script execution, Pnuts interpreter keeps track of the line number, which will be displayed when an error occurs.
Context.updateLine(int) method is called whenever the line number changes.  By overriding the method in a subclass, it is possible to cancel script execution under arbitrary condition.
</p>

<p>
The cancellation by this mechanism has a couple of assumptions:
<ul>
<li>Context.updateLine(int) method is called frequently
<li>All Java API call returns
<li>No threads are created
</ul>

Bytecode generated by the compiler, by default, does not call Context.updateLine(int) method until the line number changes.
If for-loop or while-loop is in a single line, it can't cancel the execution until the loop exits.
To cope with this problem, the initial property <tt>pnuts.compiler.traceMode</tt> should be set true, so that the updateLine() method is called for every expression.
<p>
The AST interpreter calls the method for each expression, even if the expressions are at the same line.
</p>
<p>
The following code illustrates a way to cancel script execution when a timer expires.
</p>


<pre class="eg">
public class MyContext extends Context {
  long endTime;

  public MyContext(long endTime){
    this.endTime = endTime;
  }
  protected void updateLine(int line){
    if (System.currentTimeMillis() > endTime){
      throw new Jump(null);  // return null
    }
  }
}
</pre>
<pre class="eg">
Context context = new MyContext(System.currentTimeMillis() + 10 * 1000)); // 10 seconds later
Pnuts.eval(expression, context);
</pre>
<p>
Since Pnuts.eval(String,Context) method, by default, evaluates the specified expression with the AST interpreter, the property <tt>pnuts.compiler.traceMode</tt> does not have to be set.
</p>

<div class="nav2">
<a href="guide.html">Pnuts User's Guide</a> -> Pnuts API Overview
</div>
</body>
</html>
